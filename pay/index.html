<!DOCTYPE html>
<html>
<head>
  <!--<script src="deeplink.js"></script>-->
</head>
<body>
  <div id="root">
    this is test for web-payment api
  </div>
  <script>
    //deeplink.createBrowser();
    
    const swIcons = [{
      src: "icon/lowres.webp",
      sizes: "48x48",
      type: "image/webp"
    }];
    const swEnabledMethods = [
      "https://hulpan.com/"
    ];
    const swPayName = "HULPAN_PAY";
    const instrumentKey = "c8126178-3bba-4d09-8f00-0771bcfd3b11";
    const instrumentData = {
      name: swPayName,
      enabledMethods: swEnabledMethods,
      icons: swIcons
    };
    
    instrumentParam = {
      instrumentKey,
      instrumentData 
    };
    
    Notification.requestPermission().then((permission) => {
      console.log(permission);
    }).catch((error) => {
      console.log(error);
    });
    
    var unregiHandler = function (resolve) {
      console.log("unregister success!");
      return Promise.resolve("success");
    }
    var unregiErrHandler = function (error) {
      console.log("unregister failed! " + error);
      return Promise.resolve("success");
    }
    
    var unregiLists = [];
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then((registrations) => {
        for(var i in registrations) {
          console.log(JSON.stringify(registrations[i])  + "in registrations");
          unregiLists.push(registrations[i].unregister().then(unregiHandler).catch(unregiErrHandler));
        }
      });
      Promise.all(unregiLists).then(() => {
        navigator.serviceWorker.register('sw.js', {scope: './pay'}).then((registration) => {
          registration.update().then((success) => {
            console.log("update success!" + success);
            await registration.paymentManager.paymentInstruments.set(instrumentParam);
          }).catch((error) => {
            console.log("update failed! " + error);
          });
        });
      });
    } else {
      alert('serviceWorker is not supperted!'); 
    }  
  </script>
</body>
</html>
